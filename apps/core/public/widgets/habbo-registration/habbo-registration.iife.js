(function(){"use strict";const tn=[0,1,2,3,2,1,0,7],Q=["li","lh","ls","bd","sh","lg","ch","hd","fc","ey","hr","ri","rh","rs"],C=["hr","hd","ch","lg","sh"];[...Q];const nn=44,tt=136,nt=186,V=20,bt=2,Tt=0,Et=64,St=42,yt=45,on=10,en=37,sn=45,rn={hr:82,hd:76,ch:53,lg:32,sh:21},Ft=119,Nt=200,$=235,Mt=265,Pt=44,Ot=44,b=16,M=8,T=15,ot=124,et=275,st=298,it=308,vt=3e3;let Lt="#333333";function cn(t){Lt=t}function an(){return Lt}let rt=null;async function ln(t){rt=new Map;const o=await(await fetch(`${t}data/symbols.csv`)).text(),e=new Map;for(const r of o.split(`
`)){const l=r.trim();if(!l)continue;const[f,i]=l.split(";");f&&i&&e.set(parseInt(f,10),i)}const c=await(await fetch(`${t}data/spriteoffsets.csv`)).text(),a=new Map;for(const r of c.split(`
`)){const l=r.trim();if(!l)continue;const f=l.split(";");f.length>=3&&a.set(parseInt(f[0],10),{offsetX:parseFloat(f[1]),offsetY:parseFloat(f[2])})}for(const[r,l]of e){const f=r-2,i=a.get(f);i&&rt.set(l,{imageId:f,offsetX:i.offsetX,offsetY:i.offsetY})}}function Dt(t){return rt?.get(t)}let ct={},at={},lt={},ft={};async function fn(t){const o=await(await fetch(t)).text();ct={},at={},lt={},ft={};const e={},s=o.split(`
`);for(const c of s){if(!c)continue;const[a,r,l,f,i]=c.split(","),m=a==="M"?ct:at,u=a==="M"?lt:ft;m[r]||(m[r]={});const d=`${a}:${r}`;e[d]===void 0&&(e[d]=0);const p=e[d]++;u[r]=e[d];const w={};if(f)for(const _ of f.split("|")){const[E,N]=_.split(":");w[E]=N}const g=i?i.split("|"):[];m[r][l]={indexNum:p,parts:w,colors:g}}}function D(t){return t==="female"||t==="F"?at:ct}function un(t){return t==="female"||t==="F"?ft:lt}function x(t){return t==="M"?"male":t==="F"?"female":t}function dn(t,n){n=x(n);const o=D(n),e=parseInt(t[0],10),s=parseInt(t[1],10)-1;for(const c of Object.keys(o)){const a=o[c];for(const r of Object.keys(a))if(Number(r)===e){const l=a[r],f=l.colors[s]||"FFFFFF",i=[];for(const[m,u]of Object.entries(l.parts))i.push([m,u]);return{color:f,partType:c,subParts:i}}}return null}function mn(t,n,o){t=x(t);const s=D(t)[n];if(!s)return[];for(const c of Object.values(s))if(c.indexNum===o)return c.colors;return[]}function gn(t,n,o){o=x(o);const s=D(o)[n];if(!s)return"0";for(const[c,a]of Object.entries(s))if(a.indexNum===t)return c;return"0"}function pn(t,n){n=x(n);const o=D(n);for(const e of Object.keys(o)){const s=o[e];if(s[t]!==void 0)return[s[t].indexNum,e]}return[0,"not found"]}function hn(t,n,o,e,s){t=x(t);const c=D(t),a=un(t),r=c[n];if(!r)return null;const l=a[n]||0;o==="next"?e+=1:o==="prev"?e-=1:o==="setDefault"?e=0:o==="randomize"&&(e=Math.floor(Math.random()*l)),e<0&&(e=l-1),e>l-1&&(e=0);for(const f of Object.values(r))if(f.indexNum===e){const i=f.colors.length;o==="randomize"&&(s=Math.floor(Math.random()*i)),s>i-1&&(s=i-1),s<0&&(s=0);const m=f.colors[s]||"FFFFFF",u=[];for(const[d,p]of Object.entries(f.parts))u.push([d,p]);return{setIndex:e,color:m,colorIndex:s,subParts:u}}return null}let ut={};async function wn(t){const o=await(await fetch(t)).text(),s=new DOMParser().parseFromString(o,"text/xml").getElementsByTagName("key");ut={};for(let c=0;c<s.length;c++){const a=s[c].getAttribute("name"),r=s[c].textContent;a&&r&&(ut[a]=r)}}function Y(t){return ut[t]||t}function An(t){if(t.length!==25)return C.map(()=>({modelId:"001",colorIdx:"01"}));const n=[];for(let o=0;o<5;o++){const e=t.substring(o*5,o*5+3),s=t.substring(o*5+3,o*5+5);n.push({modelId:e,colorIdx:s})}return n}function Cn(t){return t.map(n=>{const o=n.modelId.padStart(3,"0"),e=n.colorIdx.padStart(2,"0");return o+e}).join("")}function _n(t){const n=String(t);return t<10?"0"+n:n}class In{listeners=new Map;on(n,o){this.listeners.has(n)||this.listeners.set(n,[]),this.listeners.get(n).push(o)}emit(n){const o=this.listeners.get(n);o&&o.forEach(e=>e())}}const X=new In,P={};let S="male",dt=4,Rn="std",bn=0;function O(t){S=t,X.emit("genderChanged")}function Tn(t){dt=(t%8+8)%8,X.emit("directionChanged")}function En(t){Tn(dt+(t==="next"?-1:1))}function W(){return S==="female"?"F":"M"}let z=null;function Sn(t){const n={};for(const o of t.split(`
`)){if(!o)continue;const[e,s,c,a,r]=o.split(",");n[e]={x:+s,y:+c,w:+a,h:+r}}return n}async function yn(t){const[n,o]=await Promise.all([Fn(`${t}atlas.webp`),fetch(`${t}atlas.csv`).then(e=>e.text()).then(Sn)]);z={image:n,regions:o}}function Fn(t){return new Promise((n,o)=>{const e=new Image;e.onload=()=>n(e),e.onerror=()=>o(new Error(`Failed to load atlas: ${t}`)),e.src=t})}function mt(t){if(!z)return;const n=z.regions[t];if(n)return{img:z.image,x:n.x,y:n.y,w:n.w,h:n.h}}function h(t,n,o,e){t.drawImage(n.img,n.x,n.y,n.w,n.h,o,e,n.w,n.h)}function xt(t){return mt(`sprites/${t}`)}function Gt(t,n,o,e,s,c,a){const r=n.w,l=n.h;if(o===255&&e===255&&s===255){t.drawImage(n.img,n.x,n.y,r,l,c,a,r,l);return}const f=document.createElement("canvas");f.width=r,f.height=l;const i=f.getContext("2d");i.drawImage(n.img,n.x,n.y,r,l,0,0,r,l);const m=i.getImageData(0,0,r,l),u=m.data,d=o/255,p=e/255,w=s/255;for(let g=0;g<u.length;g+=4)u[g]=Math.round(u[g]*d),u[g+1]=Math.round(u[g+1]*p),u[g+2]=Math.round(u[g+2]*w);i.putImageData(m,0,0),t.drawImage(f,c,a)}function gt(t){return t=t.replace("#",""),[parseInt(t.substring(0,2),16)||0,parseInt(t.substring(2,4),16)||0,parseInt(t.substring(4,6),16)||0]}const v=new Map;function Ht(t){for(const[n,o]of v)o.mainPart===t&&v.delete(n)}function Bt(t,n,o,e){v.set(t,{partName:t,modelNum:n,mainPart:e,color:o})}function Nn(t,n){for(const o of v.values())o.mainPart===t&&(o.color=n)}function Mn(){return v}function Pn(t,n,o,e,s,c){return`${t}_${n}_${o}_${e}_${s}_${c}`}function On(t,n,o){return{action:"std",frame:0}}function vn(t,n,o,e,s,c,a=1){const r=tn[e],l=e!==r;t.save(),t.imageSmoothingEnabled=!1,l?(t.translate(n+68*a,o),t.scale(-a,a)):(t.translate(n,o),t.scale(a,a));for(const f of Q){const i=v.get(f);if(!i)continue;const{action:m,frame:u}=On(),d=Pn("h",m,f,i.modelNum,r,u),p=Dt(d);if(!p)continue;const w=xt(p.imageId);if(!w)continue;const g=p.offsetX,_=p.offsetY;if(f==="ey")h(t,w,g,_);else{const[E,N,k]=gt(i.color);Gt(t,w,E,N,k,g,_)}}t.restore()}async function G(t,n){}function A(t){return mt(`ui/${t}`)}function Ln(t,n,o,e,s){const c=rn[e]||0,a=A("prevIconBg"),r=A("prevIconMask");a&&h(t,a,n+11,o-4),t.save();const l=n+18,f=o+3,i=r?r.w:33,m=r?r.h:33;t.beginPath(),t.rect(l,f,i,m),t.clip();for(const u of Q){const d=s.get(u);if(!d||d.mainPart!==e||u==="bd"||u==="lh"||u==="rh")continue;const p=`h_std_${u}_${d.modelNum}_2_0`,w=Dt(p);if(!w)continue;const g=xt(w.imageId);if(!g)continue;const _=n+w.offsetX,E=o+w.offsetY+c;if(u==="ey")h(t,g,_,E);else{const[N,k,Rt]=gt(d.color);Gt(t,g,N,k,Rt,_,E)}}t.restore()}const F=[];function R(t){F.push(t)}function Dn(t){for(let n=F.length-1;n>=0;n--)F[n].id===t&&F.splice(n,1)}function xn(t,n){for(let o=F.length-1;o>=0;o--){const e=F[o];if(t>=e.x&&t<=e.x+e.width&&n>=e.y&&n<=e.y+e.height)return e.onClick(),!0}return!1}function Gn(t,n){for(let o=F.length-1;o>=0;o--){const e=F[o];if(t>=e.x&&t<=e.x+e.width&&n>=e.y&&n<=e.y+e.height)return e.cursor||"pointer"}return"default"}const kt=1e3/24,Hn=.04,Bn=1e3,kn=2;let I,Vt,U,$t=null,j=new Map,Yt=Temporal.Duration.from({milliseconds:0});function Vn(t,n){U=n,I=document.createElement("canvas"),I.width=406,I.height=U,I.style.display="block",I.style.imageRendering="pixelated",t.appendChild(I),Vt=I.getContext("2d"),I.addEventListener("click",o=>{const e=I.getBoundingClientRect(),s=406/e.width,c=U/e.height,a=(o.clientX-e.left)*s,r=(o.clientY-e.top)*c;xn(a,r)}),I.addEventListener("mousemove",o=>{const e=I.getBoundingClientRect(),s=406/e.width,c=U/e.height,a=(o.clientX-e.left)*s,r=(o.clientY-e.top)*c;I.style.cursor=Gn(a,r)})}function Xt(){return Vt}function $n(t){$t=t}function Yn(){zn()}function Xn(){return setInterval(()=>{Wn()},Bn)}function Wn(){let t=new Set;j.forEach((e,s)=>{Temporal.Now.instant().since(e,{smallestUnit:"second"}).seconds>=kn&&t.add(s)});const n=j.size,o=t.size;(n>0||o>0)&&console.info(`[CanvasManager] Garbage collecting animation frames! In-flight: ${n}, candidates to sweep: ${o}`),t.forEach(e=>{cancelAnimationFrame(e),j.delete(e)}),o>0&&console.info(`[CanvasManager] Swept ${o} animation frames from browser/GPU memory!`)}function zn(){const t=requestAnimationFrame(Un),n=Temporal.Now.instant();j.set(t,n)}function Un(t){const o=Temporal.Duration.from({milliseconds:Math.trunc(t)}).subtract(Yt);if(o.milliseconds>=kt-Hn){const e=t-o.milliseconds%kt;Yt=Temporal.Duration.from({milliseconds:Math.trunc(e)}),$t?.()}}function jn(t){t.clearRect(0,0,406,327);const n=A("background");n&&h(t,n,0,nn)}function Zn(t){R({x:tt-5,y:V-5,width:50,height:24,id:"gender",onClick:()=>{S!=="male"&&t("male")}}),R({x:nt-5,y:V-5,width:50,height:24,id:"gender",onClick:()=>{S!=="female"&&t("female")}})}function qn(t){const n=S==="male";t.font="bold 12px Verdana",t.fillStyle=an(),t.textAlign="center",t.fillText(Y("boy"),tt+3,bt+11),t.fillText(Y("girl"),nt+3,bt+11);const o=A("radioOn"),e=A("radioOff");o&&e&&(h(t,n?o:e,tt,V),h(t,n?e:o,nt,V))}function Kn(t){vn(t,104,226,dt,Rn,bn,2)}function Jn(t){R({x:Ft,y:$,width:28,height:28,id:"rotate",onClick:()=>t("prev")}),R({x:Nt,y:$,width:28,height:28,id:"rotate",onClick:()=>t("next")})}function Qn(t){const n=A("rotateLeft"),o=A("rotateRight");n&&h(t,n,Ft,$),o&&h(t,o,Nt,$)}function to(t){for(let n=0;n<C.length;n++){const o=St+n*yt,e=C[n];R({x:Tt,y:o,width:25,height:29,id:"partNav",onClick:()=>t(e,"prev")}),R({x:Et,y:o,width:25,height:29,id:"partNav",onClick:()=>t(e,"next")})}}function no(t){const n=A("arrowLeft"),o=A("arrowRight");for(let e=0;e<C.length;e++){const s=St+e*yt;n&&h(t,n,Tt,s),o&&h(t,o,Et,s)}}const Z={};let pt=null;function oo(t){pt=t;for(const n of C)Z[n]={colors:[],selectedIndex:0,page:0}}let ht=null;function eo(t){ht=t}let wt=null;function so(t){wt=t}function io(t,n,o){const e=Z[t];e&&(e.colors=n,e.selectedIndex=o,e.page=Math.floor(o/b),At(t))}function At(t){Dn(`color_${t}`);const n=Z[t];if(!n)return;const o=C.indexOf(t);if(o===-1)return;const e=Mt,s=Pt+o*Ot,c=n.page*b,a=Math.min(c+b,n.colors.length);for(let r=c;r<a;r++){const l=r-c,f=l%M,i=Math.floor(l/M),m=e+f*T,u=s+i*T,d=r,p=n.colors[r];R({x:m,y:u,width:T,height:T,id:`color_${t}`,onClick:()=>{n.selectedIndex=d,pt&&pt(t,p,d)}})}n.colors.length>b&&(R({x:e-20,y:s,width:18,height:29,id:`color_${t}`,onClick:()=>{const r=Math.ceil(n.colors.length/b);n.page=(n.page-1+r)%r,At(t),wt&&wt()}}),R({x:e+122,y:s,width:18,height:29,id:`color_${t}`,onClick:()=>{const r=Math.ceil(n.colors.length/b);n.page=(n.page+1)%r,At(t),ht&&ht()}}))}function ro(t){const n=A("colorButtonBg"),o=A("inactiveColorButton"),e=A("paletteSelector"),s=A("paletteArrowLeft"),c=A("paletteArrowRight");for(let a=0;a<C.length;a++){const r=C[a],l=Z[r];if(!l)continue;const f=Mt,i=Pt+a*Ot,m=l.page*b,u=Math.min(m+b,l.colors.length);for(let d=m;d<u;d++){const p=d-m,w=p%M,g=Math.floor(p/M),_=f+w*T,E=i+g*T;n&&h(t,n,_,E);const[N,k,Rt]=gt(l.colors[d]);t.fillStyle=`rgb(${N},${k},${Rt})`,t.fillRect(_+2,E+2,T-4,T-4),d===l.selectedIndex&&e&&h(t,e,_-1,E-1)}for(let d=u-m;d<b;d++){const p=d%M,w=Math.floor(d/M),g=f+p*T,_=i+w*T;o&&h(t,o,g,_)}l.colors.length>b&&(s&&h(t,s,f-20,i),c&&h(t,c,f+122,i))}}function co(t){R({x:ot,y:et,width:95,height:17,id:"randomize",onClick:t})}function ao(t){const n=A("randomizeBtn");n&&h(t,n,ot,et),t.fillStyle="#000000",t.font="bold 12px Verdana",t.textAlign="center",t.textBaseline="middle",t.fillText(Y("randomize"),ot+95/2,et+22/2)}let L=!1,Ct=null;function lo(t){L=!1,setTimeout(()=>{L=!0,R({x:st,y:it,width:108,height:19,id:"continue",onClick:()=>{L&&(t(),L=!1,setTimeout(()=>{L=!0},vt))}}),Ct!==null&&Ct()},vt)}function fo(t){Ct=t}function uo(t){t.save(),t.globalAlpha=L?1:.5;const n=A("continueBtn");n&&h(t,n,st,it),t.fillStyle="#FFFFFF",t.font="normal 12px Verdana",t.letterSpacing="0.6px",t.textAlign="center",t.textBaseline="middle";const o=Y("continue"),e=st+108/2,s=it+21/2;t.fillStyle="#FFFFFF",t.fillText(o,e,s),t.globalAlpha=.7,t.fillText(o,e,s),t.restore()}const Wt=18,mo=83;let q=[],K=0,J=null,_t=0;function go(){q=[];for(let t=1;t<=Wt;t++){const n=document.createElement("canvas"),o=mt(`frames/${t}`);if(!o){q.push(n);continue}n.width=o.w,n.height=o.h;const e=n.getContext("2d");e.drawImage(o.img,o.x,o.y,o.w,o.h,0,0,o.w,o.h);const s=e.getImageData(0,0,n.width,n.height),c=s.data;for(let a=0;a<c.length;a+=4)c[a]=255-c[a],c[a+1]=255-c[a+1],c[a+2]=255-c[a+2];e.putImageData(s,0,0),q.push(n)}}function po(t,n){_t=n,K=0,zt(t),J=window.setInterval(()=>{K=(K+1)%Wt,zt(t)},mo)}function ho(){J!==null&&(clearInterval(J),J=null)}function zt(t){const n=q[K];if(n&&n.width>0){t.clearRect(0,0,406,_t);const o=Math.floor((406-n.width)/2),e=Math.floor((_t-n.height)/2);t.drawImage(n,o,e)}}function Ut(){const t=window.HabboRegistrationConfig||{};return{figure:t.figure||"",gender:t.gender||"",rawFigure:t.figure,rawGender:t.gender,assetsPath:t.assetsPath||"./",postUrl:t.post_url||"",postEnabled:t.post_enabled??!1,postFigure:t.post_figure||"figure",postGender:t.post_gender||"gender",container:t.container||"editor-container",backgroundColor:t.backgroundColor||"",textColor:t.textColor||"",localizationUrl:t.localization_url||"data/figure_editor.xml",showSubmitButton:t.show_submit_button??!0}}function jt(t,n){const o=window.HabboRegistration?.setGenderAndFigure;o&&o(t,n)}function wo(t){const n=window.HabboRegistration?.setAllowedToProceed;n&&n(t)}function Ao(t,n){const o=window.HabboRegistration?.onSubmit;o&&o(t,n)}function Co(t){window.HabboRegistration||(window.HabboRegistration={}),window.HabboRegistration.setGender=t.onSetGender,window.HabboRegistration.setFigure=t.onSetFigure}function _o(t,n){const o=Ut();!o.postEnabled||!o.postUrl||(window.location.href=o.postUrl+o.postGender+"="+t+"&"+o.postFigure+"="+n)}async function Zt(){const t=Ut(),n=t.assetsPath,o=document.getElementById(t.container);if(!o){console.error(`No #${t.container} element found`);return}const e=t.showSubmitButton?327:300;o.style.width="406px",o.style.height=e+"px",t.backgroundColor&&(o.style.backgroundColor=t.backgroundColor),t.textColor&&cn(t.textColor),Vn(o,e),await yn(n),go(),po(Xt(),e);const s=3e3,c=Date.now();await Promise.all([ln(n),fn(n+"data/figuredata.csv"),wn(n+t.localizationUrl)]);const a=Date.now()-c;a<s&&await new Promise(i=>setTimeout(i,s-a)),ho();let r=t.figure,l=t.gender;!!(t.rawFigure&&t.rawGender)&&r.length===25&&(l==="M"||l==="F")?(O(l==="M"?"male":"female"),qt(r,l)||(O(Math.random()<.5?"male":"female"),H())):(O(Math.random()<.5?"male":"female"),H()),Zn(i=>{O(i),H()}),Jn(i=>{En(i),G(),y()}),to((i,m)=>{Io(i,m)}),oo((i,m,u)=>{P[i][1]=u,Nn(i,m),B(),y()}),eo(()=>{y()}),so(()=>{y()}),co(()=>{H()}),t.showSubmitButton&&(lo(()=>{const i=Qt();jt(W(),i),wo(!0),Ao(W(),i),_o(W(),i)}),fo(()=>{y()})),It(),await G(),$n(()=>{const i=Xt();jn(i),qn(i),Kn(i),Ro(i),no(i),ro(i),Qn(i),ao(i),t.showSubmitButton&&uo(i)}),X.on("redraw",Yn),y(),Xn(),Co({onSetGender:i=>{O(i==="M"||i==="male"?"male":"female"),H()},onSetFigure:(i,m)=>{const u=i==="M"||i==="male"?"M":"F";O(u==="M"?"male":"female"),qt(m,u)&&(It(),G().then(()=>{B(),y()}))}}),B()}function y(){X.emit("redraw")}function qt(t,n){const o=An(t);for(let e=0;e<o.length;e++){const s=o[e],c=dn([s.modelId,s.colorIdx],n);if(!c)return!1;const[a,r]=pn(s.modelId,S);if(r==="not found")return!1;const l=parseInt(s.colorIdx,10)-1;P[r]=[a,l],Ht(c.partType);for(const[f,i]of c.subParts)Bt(f,i,c.color,c.partType)}return!0}function Kt(t,n){const o=P[t]||[0,0],e=t!=="hd"?0:o[1],s=hn(S,t,n,o[0],e);if(s){P[t]=[s.setIndex,s.colorIndex],Ht(t);for(const[c,a]of s.subParts)Bt(c,a,s.color,t);Jt(t),B()}}function Io(t,n){Kt(t,n),G(),y()}function H(){for(const t of C)Kt(t,"randomize");It(),G(),B(),y()}function It(){for(const t of C)Jt(t)}function Jt(t){const n=P[t];if(!n)return;const o=mn(S,t,n[0]);io(t,o,n[1])}function Qt(){const t=C.map(n=>{const o=P[n];if(!o)return{modelId:"001",colorIdx:"01"};const e=gn(o[0],n,S),s=_n(o[1]+1);return{modelId:e,colorIdx:s}});return Cn(t)}function B(){const t=Qt();jt(W(),t)}function Ro(t){const n=Mn();for(let o=0;o<C.length;o++){const e=en+o*sn;Ln(t,on,e,C[o],n)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Zt):Zt()})();
